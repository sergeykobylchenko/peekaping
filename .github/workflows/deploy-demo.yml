name: Deploy to Demo Environment

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g. 1.2.3 or latest)'
        required: true
        type: string
        default: 'latest'
      update_release_notes:
        description: 'Update GitHub release notes with deployment status'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      version:
        description: 'Version to deploy (e.g. 1.2.3 or latest)'
        required: true
        type: string

jobs:
  deploy-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Demo Environment
        continue-on-error: true
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEMO_HOST }}
          username: ${{ secrets.DEMO_USERNAME }}
          key: ${{ secrets.DEMO_SSH_KEY }}
          port: ${{ secrets.DEMO_SSH_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting demo deployment for version ${{ inputs.version }}"

            # Navigate to the demo directory
            cd ${{ secrets.DEMO_DEPLOY_PATH || '/opt/peekaping-demo' }}

            # Update docker-compose to use the new version
            echo "ğŸ“ Updating docker-compose with new image tags..."

            # Update image tags to the new version
            sed -i "s|0xfurai/peekaping-web:.*|0xfurai/peekaping-web:${{ inputs.version }}|g" compose-demo.yaml
            sed -i "s|0xfurai/peekaping-server:.*|0xfurai/peekaping-server:${{ inputs.version }}|g" compose-demo.yaml
            sed -i "s|0xfurai/peekaping-migrate:.*|0xfurai/peekaping-migrate:${{ inputs.version }}|g" compose-demo.yaml

            echo "ğŸ“¥ Pulling new Docker images..."
            docker-compose -f compose-demo.yaml pull

            # echo "ğŸ”„ Recreating services with new images..."
            # docker-compose up -d --force-recreate

            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Demo deployment completed successfully!"
            echo "ğŸŒ Demo should be available at the configured endpoint"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "âœ… Demo deployment successful for version ${{ inputs.version }}"
            echo "ğŸŒ Demo environment updated"
          else
            echo "âŒ Demo deployment failed for version ${{ inputs.version }}"
            echo "ğŸ“‹ Check the deployment logs above for details"
